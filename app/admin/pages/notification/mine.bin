<?php $pageTitle = "Notification" ?>

<div class="row">
    <div class="col-12">
        <div class="card height-auto">
            <div class="card-body">
                <div class="heading-layout1">
                    <div class="item-title">
                        <h3>Liste de mes notifications</h3>
                    </div>
                    <div class="dropdown">
                        <a class="dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-expanded="false">...</a>
                        <div class="dropdown-menu dropdown-menu-right">
                        <a class="dropdown-item" href="#" data-action="print"><i class="fas fa-print"></i>print</a>
                    
                    <a class="dropdown-item" href="#" data-action="reload"><i class="fas fa-redo-alt text-orange-peel"></i>Actualiser</a>
                        </div>
                    </div>
                </div>
                <form class="mg-b-20" method="POST">
                    <div class="row gutters-8">
                        <div class="col-lg-5 col-12 form-group">
                            <select name="posted_on" class="select2">
                                <option value="">Selectionner un niveau</option>
                                <option value="all">Tout les monde</option>
                                <option value="sec"><?=$mci?></option>
                                <option value="opt">Option</option>
                                <option value="pmt">Promotion</option>
                                <option value="lev">Niveau</option>
                                <option value="cla">Classe</option>
                                <option value="adm">Administratif</option>
                                <option value="ens">Enseignant</option>
                                <option value="agn">Agent</option>
                                <option value="std">Etudiant</option>
                            </select>
                        </div>
                        <div class="col-lg-5 col-12 form-group">
                            <input type="text" placeholder="Search by Title ..." class="form-control">
                        </div>
                        <div class="col-lg-2 col-12 form-group">
                            <button type="submit" class="fw-btn-fill btn-gradient-yellow">RECHERCHE</button>
                        </div>
                    </div>
                </form>
                <div class="table-responsive">
                    <table class="table display data-table text-nowrap">
                        <thead>
                            <tr>
                                <th>
                                    <div class="form-check">
                                            <input type="checkbox" class="form-check-input checkAll" id="assosLabel">
                                <label for="assosLabel" class="form-check-label">Id</label>
                                    </div>
                                </th>
                                <th>Titre</th>
                                <th>Niveau d'envoi</th>
                                <th>Destinateur</th>
                                <th>Resum√©</th>
                                <th>Date</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php 
                                $array_on = array(
                                                "all" => "Tout les niveaux",
                                                "sec" => "Section",
                                                "opt" => "Option",
                                                "pmt" => "Promotion",
                                                "lev" => "Niveau",
                                                "cla" => "Classe",
                                                "adm" => "Administratif",
                                                "ens" => "Enseignant",
                                                "agn" => "Agent",
                                                "std" => "Etudiant",
                                            );
                                $getUser = function(Int $id = 0){
                                    if(!$id) return 'Tout le monde';
                                    else {
                                        $rqt = $GLOBALS['connection']->query("SELECT CONCAT(firstname, ' ', lastname) AS name FROM teachers WHERE id = $id");
                                        return ($rqt->num_rows) ? $rqt->fetch_object()->name : '';
                                    }
                                };
                                $rqt = mysqli_query($db, "SELECT * FROM notifications WHERE notifications.delete = 0 AND user_id = $user->id"
                                    .((isset($_POST['posted_on']) && $_POST['posted_on']) ? " AND posted_on = '$_POST[posted_on]'" : NULL )
                                    .((isset($_POST['posted_to']) && $_POST['posted_to']) ? " AND posted_to = $_POST[posted_to]" : NULL )
                                    .' ORDER BY posted_date DESC'
                                ) ;
                                while ($row = mysqli_fetch_array($rqt)) { $res = (object) $row;?>
                                    <tr id="Element-<?= $res->id ?>" class="<?= $res->active != 1 ? 'bg-warning' : 'Active'?>">
                                        <td>
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input">
                                                <label class="form-check-label">#<?= $res->id ?></label>
                                            </div>
                                        </td>
                                        <td><?= $res->title ?></td>
                                        <td><?= $array_on[$res->posted_on] ?></td>
                                        <td><?= $getUser($res->posted_to) ?></td>
                                        <td><?= subMyString($res->content, 49) ?></td>
                                        <td><?= $res->posted_date ?></td>
                                        <td>
                                            <div class="dropdown">
                                                <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                                                    aria-expanded="false">
                                                    <span class="flaticon-more-button-of-three-dots"></span>
                                                </a>
                                                <div class="dropdown-menu dropdown-menu-right">
                                                    <form action="?fa69951bc733eb82713e936be33597e1=DATA_CRYPTING_ON:fa69951bc733eb82713e936be33597e1=WABTECHS_CRYPTING_ON: e91497f38407364c8e86ade9098950d978814190&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3VIRAZA_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&WABTECHS_CRYPTING_ON_LAVINGOL&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&b557c222c8ddcdf87e033706aad08e4ef7cf90d3=notification--active" method="POST" class="d-none" id="active_<?= $res->id ?>">
                                                        <input type="hidden" name="id" value="<?= $res->id ?>">
                                                        <input type="hidden" name="action" value="<?= $res->active == 1 ? 'desactive' : 'active'?>">
                                                    </form>
                                                    <form action="?fa69951bc733eb82713e936be33597e1=DATA_CRYPTING_ON:fa69951bc733eb82713e936be33597e1=WABTECHS_CRYPTING_ON: e91497f38407364c8e86ade9098950d978814190&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3VIRAZA_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&WABTECHS_CRYPTING_ON_LAVINGOL&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&b557c222c8ddcdf87e033706aad08e4ef7cf90d3=notification--disable" method="POST" class="d-none" id="delete_<?= $res->id ?>">
                                                        <input type="hidden" name="id" value="<?= $res->id ?>">
                                                    </form>
                                                    <a class="dropdown-item" href="#" onclick="document.querySelector('#active_<?= $res->id ?>').submit()"><i class="fas fa-redo-alt text-orange-peel"></i><?= $res->active == 1 ? 'Desactive' : 'Active'?></a>
                                                    <a class="dropdown-item" href="?fa69951bc733eb82713e936be33597e1=DATA_CRYPTING_ON:fa69951bc733eb82713e936be33597e1=WABTECHS_CRYPTING_ON: e91497f38407364c8e86ade9098950d978814190&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3VIRAZA_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&WABTECHS_CRYPTING_ON_LAVINGOL&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&b557c222c8ddcdf87e033706aad08e4ef7cf90d3=notification--delete.$--<?= $res->id ?>"><i class="fas fa-times text-orange-red"></i>Supprimer</a>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                            <?php } ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<table class="table bs-table table-striped table-bordered text-nowrap data-table">
    <thead>
        <!-- MATIERES LISTES -->
        <?php $COTES = array('credit' => array(), 'courses' => array(), 'students' => array(),);
            $sizsOfGrille = isset($_POST['G_size'])&&$_POST['G_size']!='full'?($_POST['G_size']=='gprs'?" AND (part = 1 OR part = 3 OR part = 5)":($_POST['G_size']=='gdus'?" AND (part = 2 OR part = 4 OR part = 6)":null)):null;
            $rqt = mysqli_query($db, "SELECT courses.*, ue.ue AS ue_credit, ue.code AS ue_code, ue.name AS ue_name FROM courses LEFT JOIN ue ON ue.id = courses.ue WHERE courses.active = 1 AND courses.delete = 0 AND class = $class->id $sizsOfGrille ORDER BY part, id");
            $class_course = mysqli_num_rows($rqt); $all_courses=""; $cou_part=$ue=$_trs_ec=[];

            while ($course = mysqli_fetch_object($rqt)){
                $rqt_cote = mysqli_query($db, 
                    "SELECT `student`, `course`, 
                        ROUND(CASE WHEN `RMC` != 0 AND ".(isset($_POST['periode'])&&($_POST['periode']=='gpsn')?0:1).
                            " THEN `RMC` ELSE ((`TP1`+`TP2`+`TP3`)/12+(`INT1`+`INT2`)/8+`EXAM`/2) END,2) AS TOTAL, ".(  
                            isset($_POST['periode'])&&($_POST['periode']=='gpsn' || $_POST['periode']=='gpsr')?0:'CASE WHEN `RRC` != 0 THEN `RRC` ELSE `RATR` END '
                        ). " AS `RATR`, `JURY` FROM cotes WHERE active = 1 AND course = ".$course->id
                ) or die(mysqli_error($db));
                while($row_cote = mysqli_fetch_array($rqt_cote)) $COTES['students'][$row_cote['course']][$row_cote['student']] = $row_cote;
                isset($cou_part[$course->part])?$cou_part[$course->part]++:$cou_part[$course->part]=1;
                if(!isset($_ue[$course->part][$course->ue])) $_ue[$course->part][$course->ue] = (object)[
                    'part'  => $course->part,
                    'name'  => $course->ue_name,
                    'code'  => $course->ue_code,
                    'credit'  => 0,
                    'ec'    => [],
                    'td'    => '',
                ];  $_ue[$course->part][$course->ue]->ec[]=(object)[ 'id' => $course->id, 'credit'=>$course->credit,'name'=>$course->name];
                    $_ue[$course->part][$course->ue]->credit+=$course->credit;
                    $_ue[$course->part][$course->ue]->td.='';
            } $class_res_tot = 60*20;
            $repartition_cote = [
                'A'=>(object)['nbr'=>0,'max'=>'-'],
                'B'=>(object)['nbr'=>0,'max'=>'-'],
                'C'=>(object)['nbr'=>0,'max'=>'-'],
                'D'=>(object)['nbr'=>0,'max'=>'-'],
                'E'=>(object)['nbr'=>0,'max'=>'-'],
                'F'=>(object)['nbr'=>0,'max'=>'-'],
                'G'=>(object)['nbr'=>0,'max'=>'-'],
            ];
            $total_success = $total_echec = $moyenne_classe = 0;
            $trs_ue = $trs_ec_code = $trs_ec_credit = $trs_ue_code = $trs_ue_credit = ""; 
            $_trs_ue = $_trs_ec_code = $_trs_ec_credit = $_trs_ue_code = $_trs_ue_credit = $echec=$success=$success_res=$tr_code=$all_ue_credit=[];
            foreach ($cou_part as $k => $l) {
                $all_cou_ue = "";
                foreach ($_ue[$k] as $ue) {
                    $_trs_ue[$ue->part] = (isset($_trs_ue[$ue->part])?$_trs_ue[$ue->part]:null).'';
                    $_trs_ue_code[$ue->part] = (isset($_trs_ue_code[$ue->part])?$_trs_ue_code[$ue->part]:null).'';
                    $all_ue_credit[$k] = isset($all_ue_credit[$k])?$all_ue_credit[$k]+$ue->credit:$ue->credit;
                    if(count($ue->ec)>1){
                        $_trs_ue_credit[$ue->part] = (isset($_trs_ue_credit[$ue->part])?$_trs_ue_credit[$ue->part]:null).'';
                        foreach ($ue->ec as $i => $ec_){
                            $_trs_ec_code[$ue->part] = (isset($_trs_ec_code[$ue->part])?$_trs_ec_code[$ue->part]:'').'';
                            $_trs_ec_credit[$ue->part] = (isset($_trs_ec_credit[$ue->part])?$_trs_ec_credit[$ue->part]:'').'';
                            $_trs_ec[$ec_->id] = (object)[
                                'std' => $COTES['students'][$ec_->id] ?? [],
                                'credit' => $ec_->credit,
                                'part' => $ue->part,
                            ];
                        }
                    } else {
                        $_trs_ue_credit[$ue->part] = (isset($_trs_ue_credit[$ue->part])?$_trs_ue_credit[$ue->part]:null).'';
                        $_trs_ec[$ue->ec[0]->id] = (object)[
                            'std' => $COTES['students'][$ue->ec[0]->id] ?? [],
                            'credit' => $ue->ec[0]->credit,
                            'part' => $ue->part,
                        ];
                    } $all_cou_ue.= $ue->td; 
                } $all_courses .= $all_cou_ue."<th class=write-mode-tb><span>CREDITS VALIDÉS SEMESTRE $k</span><th class=write-mode-tb><span>COTE OBTENUE SEMESTRE $k</span>";
                $trs_ue .= $_trs_ue[$k]; 
                $trs_ue_code .= $_trs_ue_code[$k]."<th class=align-middle colspan=2>SEM $k</th>";
                $trs_ue_credit .= $_trs_ue_credit[$k]."<th class=align-middle>$all_ue_credit[$k]</th><th class=align-middle>10</th>";
                $trs_ec_code .= isset($_trs_ec_code[$k])?$_trs_ec_code[$k]:null; 
                $trs_ec_credit .= isset($_trs_ec_credit[$k])?$_trs_ec_credit[$k]:null; 
                $echec[$k]=$success_res[$k]=$success[$k]=0;$tr_code[$k]="";
            } $trs_ue_credit.='<th class=align-middle>'.array_sum($all_ue_credit).'</th><th class=align-middle>20</th>'; 
        ?>
        <tr>
            <!-- LES UNITES D'ENSEINGEMENTS -->
            <th rowspan=3 style=vertical-align:bottom>NUM.</th>
            <th rowspan=3 style=vertical-align:bottom>NOM & POSTNOM</th>
            <?=$trs_ue_code?>
            <th colspan=5 class=align-middle>FINAL</th>
        </tr>
        <tr>
            <!-- LES CREDITS PAR UNITE D'ENSEINGEMENT -->
            <?=$trs_ue_credit?>
            <th rowspan="2" class=write-mode-tb><span>GRADE (CECT)</span></th>
            <th rowspan="2" class=write-mode-tb><span>PASSABLE</span></th>
            <th rowspan="2" class=write-mode-tb><span>ACTIONS</span></th>   
        </tr>
        <tr>
            <!-- MATIERES LISTES -->
            <?=$all_courses?>
            <th class=write-mode-tb><span>TOTAL GENERAL - CREDITS VALIDÉS</span></th><th class=write-mode-tb><span>MOYENNE GENERALE ANNUELLE</span></th>
        </tr>
    </thead>
    <tbody>
        <?php $periode = ($_POST['periode']??NULL) == 'gpsr' ? "finish_in = 'gpsr' OR finish_in = 'gdsn' OR finish_in = 'gdsr'" : 
                        (($_POST['periode']??NULL) == 'gdsn' ? "finish_in = 'gdsn' OR finish_in = 'gdsr'" :
                        (($_POST['periode']??NULL) == 'gdsr' ? "finish_in = 'gdsr'" : 1)) ;
              $rqt_std = mysqli_query($db, "SELECT students.*, palmares.completed, palmares.resultat,
                            (SELECT DISTINCT cotes.student FROM cotes WHERE cotes.RMC AND cotes.student = students.id) AS gpsr,
                            (SELECT DISTINCT cotes.student FROM cotes WHERE cotes.RRC AND cotes.student = students.id) AS pdsr
                        FROM students LEFT JOIN palmares ON palmares.student = students.id WHERE (finish_in IS NULL OR $periode) AND active = 1 AND students.delete = 0 AND students.class = ".$class->id." ORDER BY students.firstname, students.lastname".(isset($std_trancon)&&$std_trancon!=0?' LIMIT 100 OFFSET '.(--$std_trancon):null));
            $count = 0;
            $all_count_std = mysqli_num_rows($rqt_std);
            while($std = mysqli_fetch_object($rqt_std)) {
                if (isset($_POST['periode'])&&($_POST['periode']=='RSR' || $_POST['periode']=='ASR') && $std->completed == 1 && $std->resultat > 50) continue;
                $cote_credit=$res_success=$res_echec=$credits=0; $cote = array();
            ?><tr class="delibereBtn" data-gpsr="<?=$std->gpsr?>" data-pdsr="<?=$std->pdsr?>" id='std_<?=$std->id?>'>
                <!-- DATA STUDENT -->
                <td><?= ++$count ?></td>
                <td class="text-left"><?= "$std->firstname $std->lastname" ?></td>
                <!-- RESULT STUDENT -->
                <?php foreach($_trs_ec AS $idx => $course) {
                    $jury=$cote=$dataIsset=0;
                    if(isset($course->std[$std->id])){
                        $dataIsset = 1;
                        $pre_cote = $course->std[$std->id]['TOTAL']+0;
                        $cote = (($course->std[$std->id]['RATR']??0)>$pre_cote ? $course->std[$std->id]['RATR'] : $pre_cote) ;
                        $jury = $course->std[$std->id]['JURY'];
                    }
                    $cote_credit+=($final = ($jury&&($jury>$cote||$jury>=10)?$jury:$cote))*$course->credit;
                    $success_res[$course->part]+=($final = ($jury&&($jury>$cote||$jury>=10)?$jury:$cote))*$course->credit;
                    if($final < 10) $echec[$course->part]+=$course->credit; 
                    else $success[$course->part]+=$course->credit; $credits+=$course->credit;
                    $tr_code[$course->part].='';
                } foreach ($cou_part as $k => $l) {
                    echo $tr_code[$k]."<td class=font-bold>$success[$k]<td class=font-bold>".number_format($success_res[$k]/60,2).'</td>'; 
                    $success_res[$k]=0;
                    $res_success+= $success[$k]; $res_echec+= $echec[$k];
                    $tr_code[$k]=""; $success[$k]=$echec[$k]=0;
                } echo '<td class=font-bold>'.$res_success.'</td>';?>

                <!-- RESULT CALC -->                
                <td class=font-bold><?= $cote_credit ? number_format($res=$cote_credit/60,2):$res=0?></td>
                <td class=font-bold><?= $mention = (($res >= 18) ? 'A' : (($res >= 16) ? 'B' : (($res >= 14) ? 'C' : (($res >= 12) ? 'D' : (($res >= 10) ? 'E' : (($res >= 8) ? 'F' : 'G'))))))?></td>
                <td class=font-bold><?=$res>=10&&$res_success>=45?'<i class="fa fa-check"></i>':'<i class="fa fa-times"></i>'?></td>
                <td class="del-print lastTd" data-periode="<?=$_POST['periode']??'full'?>" data-ended="<?= ($res>=10&&$res_success==60)?1:0 ?>" data-passable="<?= ($res>=10&&$res_success>=45)?1:0 ?>" data-completed=1 data-student=<?=$std->id?> data-resultat=<?=$res?> data-mention=<?=$mention?> data-credit=<?=$res_success?>>
                    <div class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-expanded="false" aria-label="Plus d'option">
                            <span class="flaticon-more-button-of-three-dots"></span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right">
                            <a class="dropdown-item" href="?fa69951bc733eb82713e936be33597e1=DATA_CRYPTING_ON:fa69951bc733eb82713e936be33597e1=WABTECHS_CRYPTING_ON: e91497f38407364c8e86ade9098950d978814190&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3VIRAZA_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&WABTECHS_CRYPTING_ON_LAVINGOL&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&b557c222c8ddcdf87e033706aad08e4ef7cf90d3=student--details--<?= $std->id ?>"><i class="fas fa-cogs text-dark-pastel-green"></i>Profile</a>
                            <a class="dropdown-item" data-exec="backStudent(<?= $std->id ?>)"><i class="fas fa-left-long text-primary"></i>Back</a>
                            <a class="dropdown-item" data-exec="backStudent(<?= $std->id ?>, 'gpsn')"><i class="fas fa-left-long text-primary"></i>Back (S1)</a>
                            <a class="dropdown-item" data-exec="backStudent(<?= $std->id ?>, 'gpsr')"><i class="fas fa-left-long text-primary"></i>Back (S1R)</a>
                            <a class="dropdown-item" data-exec="backStudent(<?= $std->id ?>, 'gdsn')"><i class="fas fa-left-long text-primary"></i>Back (S2)</a>
                            <a class="dropdown-item" data-exec="backStudent(<?= $std->id ?>, 'gdsr')"><i class="fas fa-left-long text-primary"></i>Back (S2R)</a>
                            <a class="dropdown-item" data-exec="stdPassed(<?= $std->id ?>)"><i class="fas fa-start text-primary"></i>Passed</a>
                            <a class="dropdown-item" data-exec="open('/app/admin/pages/actions/student-resultat?code=<?= $std->key ?>&anacad=2022')"><i class="fas fa-redo-alt text-orange-peel"></i>Bulletin</a>
                        </div>
                    </div>
                </td>
            </tr>
        <?php
        ($res>=10&&$res_success>=45)?$total_success++:$total_echec++; $moyenne_classe+=$res/$all_count_std;
        $repartition_cote[$mention]->nbr++;
        if($repartition_cote[$mention]->max<$res) $repartition_cote[$mention]->max=$res;
    } ?>
    </tbody>
</table>
<br><br>
<h3 class="w-100 alert alert-info">SYNTHESE DE RESULTATS</h3>
<table class="table bs-table table-striped table-bordered text-nowrap">
    <thead>
        <tr>
            <th colspan=2>STATISTIQUES</th>
            <th class=border-0></th>
            <th class=border-0></th>
            <tH colspan=8>REPARTITION</tH>
        </tr>
    </thead>
    <tbody>
        <tr>
            <th>NOMBRE DE REUSSITE</th>
            <td><?=$total_success?></td>
            <td class="border-0"></td>
            <td class="border-0"></td>
            <th>GRADE (CECT)</th>
            <td>A</td><td>B</td><td>C</td><td>D</td><td>E</td><td>F</td><td>G</td>
        </tr>
        <tr>
            <th>NOMBRE D'ECHEC</th>
            <td><?=$total_echec?></td>
            <td class="border-0"></td>
            <td class="border-0"></td>
            <th>NOMBRE DE RESULTATS</th>
            <td><?=$repartition_cote['A']->nbr?></td><td><?=$repartition_cote['B']->nbr?></td><td><?=$repartition_cote['C']->nbr?></td><td><?=$repartition_cote['D']->nbr?></td><td><?=$repartition_cote['E']->nbr?></td><td><?=$repartition_cote['F']->nbr?></td><td><?=$repartition_cote['G']->nbr?></td>
        </tr>
        <tr>
            <th>MOYENNE CLASSE</th>
            <td><?=$moyenne_classe?></td>
            <td class="border-0"></td>
            <td class="border-0"></td>
            <th>COTE MAXIMALE</th>
            <td><?=$repartition_cote['A']->max?></td><td><?=$repartition_cote['B']->max?></td><td><?=$repartition_cote['C']->max?></td><td><?=$repartition_cote['D']->max?></td><td><?=$repartition_cote['E']->max?></td><td><?=$repartition_cote['F']->max?></td><td><?=$repartition_cote['G']->max?></td>
        </tr>
    </tbody>
</table>

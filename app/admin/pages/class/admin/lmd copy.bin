<thead>
    <!-- MATIERES LISTES -->
    <?php $COTES = array('credit' => array(), 'courses' => array(), 'students' => array(),);
        $sizsOfGrille = isset($_POST['G_size'])&&$_POST['G_size']!='full'?($_POST['G_size']=='gprs'?" AND (part = 1 OR part = 3 OR part = 5)":($_POST['G_size']=='gdus'?" AND (part = 2 OR part = 4 OR part = 6)":null)):null;
        $rqt = mysqli_query($db, "SELECT courses.*, ue.ue AS ue_credit, ue.code AS ue_code, ue.name AS ue_name FROM courses LEFT JOIN ue ON ue.id = courses.ue WHERE courses.active = 1 AND courses.delete = 0 AND class = $class->id $sizsOfGrille ORDER BY part, id");
        $class_course = mysqli_num_rows($rqt); $all_courses=""; $cou_part=$ue=$_trs_ec=[];

        while ($course = mysqli_fetch_object($rqt)){
            $rqt_cote = mysqli_query($db, 
                "SELECT `student`, `course`, 
                    ROUND(CASE WHEN `RMC` != 0 AND ".(isset($_POST['periode'])&&($_POST['periode']=='gpsn')?0:1).
                        " THEN `RMC` ELSE ((`TP1`+`TP2`+`TP3`)/12+(`INT1`+`INT2`)/8+`EXAM`/2) END,2) AS TOTAL, ".(  
                        isset($_POST['periode'])&&($_POST['periode']=='gpsn' || $_POST['periode']=='gpsr')?0:'CASE WHEN `RRC` != 0 THEN `RRC` ELSE `RATR` END '
                    ). " AS `RATR`, `JURY` FROM cotes WHERE active = 1 AND course = ".$course->id
            ) or die(mysqli_error($db));
            while($row_cote = mysqli_fetch_array($rqt_cote)) $COTES['students'][$row_cote['course']][$row_cote['student']] = $row_cote;
            isset($cou_part[$course->part])?$cou_part[$course->part]++:$cou_part[$course->part]=1;
            if(!isset($_ue[$course->part][$course->ue])) $_ue[$course->part][$course->ue] = (object)[
                'part'  => $course->part,
                'name'  => $course->ue_name,
                'code'  => $course->ue_code,
                'credit'  => 0,
                'ec'    => [],
                'td'    => '',
            ];  $_ue[$course->part][$course->ue]->ec[]=(object)[ 'id' => $course->id, 'credit'=>$course->credit,'name'=>$course->name];
                $_ue[$course->part][$course->ue]->credit+=$course->credit;
                $_ue[$course->part][$course->ue]->td.='<th class="write-mode-tb fw-100"><span>'.$course->name.'</span></th>';
        } $class_res_tot = 60*20;
        $repartition_cote = [
            'A'=>(object)['nbr'=>0,'max'=>'-'],
            'B'=>(object)['nbr'=>0,'max'=>'-'],
            'C'=>(object)['nbr'=>0,'max'=>'-'],
            'D'=>(object)['nbr'=>0,'max'=>'-'],
            'E'=>(object)['nbr'=>0,'max'=>'-'],
            'F'=>(object)['nbr'=>0,'max'=>'-'],
            'G'=>(object)['nbr'=>0,'max'=>'-'],
        ];
        $total_success = $total_echec = $moyenne_classe = 0;
        $trs_cou_part = $trs_ue = $trs_ec_code = $trs_ec_credit = $trs_ue_code = $trs_ue_credit = ""; 
        $_trs_ue = $_trs_ec_code = $_trs_ec_credit = $_trs_ue_code = $_trs_ue_credit = $echec=$success=$tr_code=$all_ue_credit=[];
        foreach ($cou_part as $k => $l) {
            $all_cou_ue = "";
            foreach ($_ue[$k] as $ue) {
                $_trs_ue[$ue->part] = (isset($_trs_ue[$ue->part])?$_trs_ue[$ue->part]:null).'<th colspan='.count($ue->ec).'>'.$ue->name.'</th>';
                $_trs_ue_code[$ue->part] = (isset($_trs_ue_code[$ue->part])?$_trs_ue_code[$ue->part]:null).'<th class=align-middle colspan='.count($ue->ec).'>'.(count($ue->ec)==1?substr($ue->code??'', 0, 3).'<br>'.substr($ue->code??'', 3, 3):$ue->code).'</th>';
                $all_ue_credit[$k] = isset($all_ue_credit[$k])?$all_ue_credit[$k]+$ue->credit:$ue->credit;
                if(count($ue->ec)>1){
                    $_trs_ue_credit[$ue->part] = (isset($_trs_ue_credit[$ue->part])?$_trs_ue_credit[$ue->part]:null).'<th colspan='.count($ue->ec).'>'.$ue->credit.'</th>';
                    foreach ($ue->ec as $i => $ec_){
                        $_trs_ec_code[$ue->part] = (isset($_trs_ec_code[$ue->part])?$_trs_ec_code[$ue->part]:'').'<th>EC'.($i+1).'</th>';
                        $_trs_ec_credit[$ue->part] = (isset($_trs_ec_credit[$ue->part])?$_trs_ec_credit[$ue->part]:'')."<th>$ec_->credit</th>";
                        $_trs_ec[$ec_->id] = (object)[
                            'std' => $COTES['students'][$ec_->id] ?? [],
                            'credit' => $ec_->credit,
                            'part' => $ue->part,
                        ];
                    }
                } else {
                    $_trs_ue_credit[$ue->part] = (isset($_trs_ue_credit[$ue->part])?$_trs_ue_credit[$ue->part]:null).'<th class=align-middle rowspan=3 colspan='.count($ue->ec).'>'.$ue->credit.'</th>';
                    $_trs_ec[$ue->ec[0]->id] = (object)[
                        'std' => $COTES['students'][$ue->ec[0]->id] ?? [],
                        'credit' => $ue->ec[0]->credit,
                        'part' => $ue->part,
                    ];
                } $all_cou_ue.= $ue->td; 
            } $all_courses .= $all_cou_ue."<th class=write-mode-tb><span>CREDIT VALIDÉS SEMESTRE $k</span>";
            $trs_cou_part .= "<th colspan=".($l+1).">SEMESTRE $k</th>";
            $trs_ue .= $_trs_ue[$k]; 
            $trs_ue_code .= $_trs_ue_code[$k]."<th class=align-middle>SEM $k</th>";
            $trs_ue_credit .= $_trs_ue_credit[$k]."<th class=align-middle rowspan=3>$all_ue_credit[$k]</th>";
            $trs_ec_code .= isset($_trs_ec_code[$k])?$_trs_ec_code[$k]:null; 
            $trs_ec_credit .= isset($_trs_ec_credit[$k])?$_trs_ec_credit[$k]:null; 
            $echec[$k]=$success[$k]=0;$tr_code[$k]="";
        }   $trs_ue_credit.='<th class=align-middle rowspan=3>'.array_sum($all_ue_credit).'</th><th class=align-middle rowspan=3>20</th>';
        $all_courses.="<th class=write-mode-tb><span>TOTAL GENERALE - CREDIT VALIDÉS</span></th><th class=write-mode-tb><span>MOYENNE GENERALE ANNUELLE</span></th>"; 
    ?>
    <tr>
        <th rowspan="6" colspan="2"><?= "$class->level_name <br /> $class->option_name".($class->name ? " <br /> $class->name" : null) ?></th>
        <?= $class_course ? '<th colspan="'.($class_course+count($cou_part)).'">Matières</th>' : NULL ?>
        <th rowspan="3" colspan="4" style="vertical-align:middle">Résultats</th>
        <th rowspan="7" rowspan="2" class="del-print">ACTIONS</th>
    </tr>
    <tr>
        <?=$trs_cou_part?>
    </tr>
    <tr>
        <!-- LES UNITES D'ENSEINGEMENTS -->
        <?=$trs_ue_code?>
    </tr>
    <tr>
        <!-- LES CREDITS PAR UNITE D'ENSEINGEMENT -->
        <?=$trs_ue_credit?>
        <th rowspan="4" class=write-mode-tb><span>GRADE (CECT)</span></th>
        <th rowspan="4" class=write-mode-tb><span>PASSABLE</span></th>
    </tr>
    <tr>
        <!-- LES CODES DES ELEMENTS CONTITUTIFS -->
        <?=$trs_ec_code?>
    </tr>
    <tr>
        <!-- LES CREDITS DES ELEMENTS CONTITUTIFS -->
        <?=$trs_ec_credit?>
    </tr>
    <tr>
        <!-- MATIERES LISTES -->
        <th style="vertical-align:bottom">NUM.</th>
        <th style="vertical-align:bottom">NOM & POSTNOM</th>
        <?=$all_courses?>
    </tr>
</thead>
<tbody>
    <?php $periode = ($_POST['periode']??NULL) == 'gpsr' ? "finish_in = 'gpsr' OR finish_in = 'gdsn' OR finish_in = 'gdsr'" : 
            (($_POST['periode']??NULL) == 'gdsn' ? "finish_in = 'gdsn' OR finish_in = 'gdsr'" :
            (($_POST['periode']??NULL) == 'gdsr' ? "finish_in = 'gdsr'" : 1)) ;
        $rqt_std = mysqli_query($db, "SELECT students.*, palmares.completed, palmares.resultat,
            (SELECT DISTINCT cotes.student FROM cotes WHERE cotes.RMC AND cotes.student = students.id) AS gpsr,
            (SELECT DISTINCT cotes.student FROM cotes WHERE cotes.RRC AND cotes.student = students.id) AS pdsr
        FROM students LEFT JOIN palmares ON palmares.student = students.id WHERE (finish_in IS NULL OR $periode) AND active = 1 AND students.delete = 0 AND students.class = ".$class->id." ORDER BY students.firstname, students.lastname".(isset($std_trancon)&&$std_trancon!=0?' LIMIT 100 OFFSET '.(--$std_trancon):null));
            
        $count = 0; $all_count_std = mysqli_num_rows($rqt_std);
        while($std = mysqli_fetch_object($rqt_std)) {
            if (isset($_POST['periode'])&&($_POST['periode']=='RSR' || $_POST['periode']=='ASR') && $std->completed == 1 && $std->resultat > 50) continue;
            $cote_credit=$res_success=$res_echec=$credits=0; $cote = array();
            $echo = "";
        ?><tr class="delibereBtn" data-gpsr="<?=$std->gpsr?>" data-pdsr="<?=$std->pdsr?>" id='std_<?=$std->id?>'>
            <!-- DATA STUDENT -->
            <td><?= ++$count ?></td>
            <td class="text-left"><?= "$std->firstname $std->lastname" ?></td>

            <!-- RESULT STUDENT -->
            <?php foreach($_trs_ec AS $idx => $course) {
                $jury=$cote=$dataIsset=0;
                if(isset($course->std[$std->id])){
                    $dataIsset = 1;
                    $pre_cote = $course->std[$std->id]['TOTAL']+0;
                    $cote = (($course->std[$std->id]['RATR']??0)>$pre_cote ? $course->std[$std->id]['RATR'] : $pre_cote) ;
                    $jury = $course->std[$std->id]['JURY'];
                }
                $cote_credit+=($final = ($jury&&($jury>$cote||$jury>=10)?$jury:$cote))*$course->credit;
                if($final < 10) $echec[$course->part]+=$course->credit; else {$success[$course->part]+=$course->credit; $credits+=$course->credit;}
                $tr_code[$course->part].="<th data-student='$std->id' data-isset='$dataIsset' data-course='$idx' data-cote='$cote'".($jury && $jury != $cote?"data-toggle=tooltip data-placement=top data-original-title='$cote' data-simbing":null).' class="text-center '.($final < 10 ? 'text-danger' : 'text-success').'">'.$final.'</th>';
            } foreach ($cou_part as $k => $l) {
                echo $tr_code[$k]."<td class=font-bold>$success[$k]</td>"; 
                $res_success+= $success[$k]; $res_echec+= $echec[$k];
                $tr_code[$k]=""; $success[$k]=$echec[$k]=0;
            } echo '<td class=font-bold>'.$res_success.'</td>';?>

            <!-- RESULT CALC -->                
            <td class=font-bold><?= $cote_credit ? number_format($res=$cote_credit/60,2):$res=0?></td>
            <td class=font-bold><?= $mention = (($res >= 18) ? 'A' : (($res >= 16) ? 'B' : (($res >= 14) ? 'C' : (($res >= 12) ? 'D' : (($res >= 10) ? 'E' : (($res >= 8) ? 'F' : 'G'))))))?></td>
            <td class=font-bold><?=$res>=10&&$res_success>=45?'<i class="fa fa-check"></i>':'<i class="fa fa-times"></i>'?></td>
            <td class="del-print lastTd" data-periode="<?=$_POST['periode']??'full'?>" data-ended="<?= ($res>=10&&$res_success==60)?1:0 ?>" data-completed=1 data-student=<?=$std->id?> data-resultat=<?=$res?> data-mention=<?=$mention?> data-credit=<?=$res_success?>>
                <div class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-expanded="false" aria-label="Plus d'option">
                        <span class="flaticon-more-button-of-three-dots"></span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right">
                        <a class="dropdown-item" href="?fa69951bc733eb82713e936be33597e1=DATA_CRYPTING_ON:fa69951bc733eb82713e936be33597e1=WABTECHS_CRYPTING_ON: e91497f38407364c8e86ade9098950d978814190&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3VIRAZA_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&WABTECHS_CRYPTING_ON_LAVINGOL&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&b557c222c8ddcdf87e033706aad08e4ef7cf90d3=student--details--<?= $std->id ?>"><i class="fas fa-cogs text-dark-pastel-green"></i>Profile</a>
                        <a class="dropdown-item" data-exec="backStudent(<?= $std->id ?>)"><i class="fas fa-left-long text-primary"></i>Back</a>
                            <a class="dropdown-item" data-exec="backStudent(<?= $std->id ?>, 'gpsn')"><i class="fas fa-left-long text-primary"></i>Back (S1)</a>
                            <a class="dropdown-item" data-exec="backStudent(<?= $std->id ?>, 'gpsr')"><i class="fas fa-left-long text-primary"></i>Back (S1R)</a>
                            <a class="dropdown-item" data-exec="backStudent(<?= $std->id ?>, 'gdsn')"><i class="fas fa-left-long text-primary"></i>Back (S2)</a>
                            <a class="dropdown-item" data-exec="backStudent(<?= $std->id ?>, 'gdsr')"><i class="fas fa-left-long text-primary"></i>Back (S2R)</a>
                        <a class="dropdown-item" data-exec="open('/app/admin/pages/actions/student-resultat?code=<?= $std->key ?>&anacad=2022')"><i class="fas fa-redo-alt text-orange-peel"></i>Bulletin</a>
                    </div>
                </div>
            </td>
        </tr>
    <?php
    ($res>=10&&$res_success>=45)?$total_success++:$total_echec++; $moyenne_classe+=$res/$all_count_std;
    $repartition_cote[$mention]->nbr++;
    if($repartition_cote[$mention]->max<$res) $repartition_cote[$mention]->max=$res;
} ?>
</tbody>

<?php $pageTitle = "Liste des Cours" ;
    $_SESSION['DATA_CURRENT_SELECT'] = isset($_SESSION['DATA_CURRENT_SELECT']) ? $_SESSION['DATA_CURRENT_SELECT'] : [];
    $_POST['section_select_value'] = isset($_POST['section_select_value']) ? $_POST['section_select_value'] : (isset($_SESSION['DATA_CURRENT_SELECT']['section_select_value']) ? $_SESSION['DATA_CURRENT_SELECT']['section_select_value'] : NULL);
    $_SESSION['DATA_CURRENT_SELECT']['section_select_value'] = $_POST['section_select_value'] ;
    $_POST['option_select_value'] = isset($_POST['option_select_value']) ? $_POST['option_select_value'] : (isset($_SESSION['DATA_CURRENT_SELECT']['option_select_value']) ? $_SESSION['DATA_CURRENT_SELECT']['option_select_value'] : NULL);
    $_SESSION['DATA_CURRENT_SELECT']['option_select_value'] = $_POST['option_select_value'] ;
 ?>

<div class="card height-auto">
    <div class="card-body">
        <div class="heading-layout1">
            <div class="item-title">
                <h3>Liste de Cours</h3>
            </div>
            <div class="dropdown">
                <a class="dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-expanded="false">...</a>
                <div class="dropdown-menu dropdown-menu-right">
                    <a class="dropdown-item" href="#" data-action="print"><i class="fas fa-print"></i>print</a>
                    
                    <a class="dropdown-item" href="#" data-action="reload"><i class="fas fa-redo-alt text-orange-peel"></i>Actualiser</a>
                </div>
            </div>
        </div>
        <form class="mg-b-20" method="POST">
            <div class="row gutters-8">
                <div class="col-xl-4 col-lg-6 col-12 form-group">
                    <input type="hidden" name="CON_47" value="true">
                    <label><?=$mci?></label>
                    <select class="select2" name="section_select_value" id="s_sec">
                        <option value="*">Toutes les <?=$mci?>s</option>
                        <?php $rqt = mysqli_query($db, "SELECT id, name FROM sections WHERE active = 1") or die(debug(mysqli_error($db)));
                            while ($row = mysqli_fetch_object($rqt)){ ?>
                                <option value="<?= $row->id ?>" <?php if(isset($_POST['section_select_value']) && $row->id == $_POST['section_select_value']) {echo 'selected'; $_fs = $row->id;} ?>><?= $row->name ?></option>
                        <?php } ?>
                    </select>
                </div>
                <div class="col-xl-4 col-lg-6 col-12 form-group">
                    <label>Option</label>
                    <select class="select2" name="option_select_value" id="s_opt">
                        <option value="*">Toutes les options</option>
                        <?php $rqt = mysqli_query($db, "SELECT id, name FROM options WHERE active = 1") or die(debug(mysqli_error($db)));
                            while ($row = mysqli_fetch_object($rqt)){ ?>
                                <option value="<?= $row->id ?>" <?php if(isset($_POST['option_select_value']) && $row->id == $_POST['option_select_value']) {echo 'selected'; $_fo = $row->id;} ?>><?= $row->name ?></option>
                            <?php } ?>
                    </select>
                </div>
                <div class="col-xl-4 col-lg-6 col-12 form-group">
                    <label>Niveau</label>
                    <select class="select2" name="level">
                        <option selected value="*">Tous les niveaux</option>
                        <?php $rqt = mysqli_query($db, "SELECT * FROM level WHERE active = 1") or die(debug(mysqli_error($db)));
                            while ($row = mysqli_fetch_object($rqt)){ ?>
                                <option value="<?= $row->id ?>"><?= $row->name ?></option>
                        <?php } ?>
                        <input type="hidden" name="CON_47" value="true">
                    </select>
                </div>
                <div class="col-12 form-group">
                    <label></label>
                    <button type="submit" class="fw-btn-fill btn-gradient-yellow">RECHERCHE</button>
                </div>
            </div>
        </form>
        <div class="table-responsive">
            <table class="table display data-table text-nowrap">
                <thead>
                    <tr>
                        <th>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input checkAll" id="assosLabel">
                                <label for="assosLabel" class="form-check-label">Id</label>
                            </div>
                        </th>
                        <th>Designation</th>
                        <th><?=$mci?></th>
                        <th>Option</th>
                        <th>Niveau</th>
                        <th>Classe</th>
                        <th>Promotion</th>
                        <th>Code</th>
                        <th>Credit</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <?php $pre_res = ""; $pre_rqt = mysqli_query($db, "SELECT id FROM classes WHERE active = 1"
                                            .((isset($_POST['promotion']) && $_POST['promotion'] != "*") ? " AND promotion = $_POST[promotion]":'')
                                            .((isset($_POST['section_select_value']) && $_POST['section_select_value'] != "*") ? " AND `section` = $_POST[section_select_value]":'')
                                            .((isset($_POST['option_select_value']) && $_POST['option_select_value'] != "*") ? " AND `option` = $_POST[option_select_value]":'')
                                            .((isset($_POST['level']) && $_POST['level'] != "*") ? " AND `level` = $_POST[level]":'')
                                        );
                    while($pre_row = mysqli_fetch_array($pre_rqt)) $pre_res .= " OR classes.id = $pre_row[0]";
                    
                    while($pre_row = mysqli_fetch_array($pre_rqt)) $pre_res += " OR classes.id = $pre_row[0]";

                    $rqt = mysqli_query($db, 
                        "SELECT courses.*, classes.id AS classe, sections.id AS section, options.id AS `option`, level.id AS level, classes.promotion, classes.name AS designation, CONCAT(teachers.firstname, ' ', teachers.lastname) AS titulary, sections.name AS section_name, options.name AS option_name, level.name AS level_name 
                            FROM courses 
                            LEFT JOIN teachers ON teachers.id = courses.titular 
                            LEFT JOIN classes  ON classes.id  = courses.class 
                            LEFT JOIN sections ON sections.id = classes.section 
                            LEFT JOIN options  ON options.id  = classes.option 
                            LEFT JOIN level    ON level.id    = classes.level 
                            WHERE teachers.user_id = $user->id AND classes.active = 1 AND classes.delete = 0 AND courses.active = 1 AND courses.delete = 0".(($pre_res != "")?" AND (classes.id = 0 $pre_res)":"")) or die(debug(mysqli_error($db)));
                        while ($row = mysqli_fetch_object($rqt)){ ?>
                            <tr id="Element-<?= $row->id ?>">
                                <td>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input">
                                        <label class="form-check-label">#<?= $row->id ?></label>
                                    </div>
                                </td>
                                <td><?= $row->name ?></td>
                                <td><?= $row->section_name ?></td>
                                <td><?= $row->option_name ?></td>
                                <td><?= $row->level_name ?></td>
                                <td><?= $row->designation ?></td>
                                <td><?= $row->promotion.' - '.++$row->promotion ?></td>
                                <td><?= $row->code ?></td>
                                <td><?= $row->credit ?></td>
                                <td>
                                    <div class="dropdown">
                                        <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                                            aria-expanded="false">
                                            <span class="flaticon-more-button-of-three-dots"></span>
                                        </a>
                                        <div class="dropdown-menu dropdown-menu-right">
                                            <?php if($row->TFE != 1){ ?>
                                                <a class="dropdown-item" href="?fa69951bc733eb82713e936be33597e1=DATA_CRYPTING_ON:fa69951bc733eb82713e936be33597e1=WABTECHS_CRYPTING_ON: e91497f38407364c8e86ade9098950d978814190&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3VIRAZA_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&WABTECHS_CRYPTING_ON_LAVINGOL&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&b557c222c8ddcdf87e033706aad08e4ef7cf90d3=course--cote--<?= $row->id ?>"><i class="fas fa-grip-vertical text-blue"></i>Grille</a>
                                                <a class="dropdown-item" href="?fa69951bc733eb82713e936be33597e1=DATA_CRYPTING_ON:fa69951bc733eb82713e936be33597e1=WABTECHS_CRYPTING_ON: e91497f38407364c8e86ade9098950d978814190&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3VIRAZA_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&WABTECHS_CRYPTING_ON_LAVINGOL&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&b557c222c8ddcdf87e033706aad08e4ef7cf90d3=course--recours--<?= $row->id ?>"><i class="fas fa-grip-vertical text-blue"></i>Grille (Recours)</a>
                                                <a class="dropdown-item" href="?fa69951bc733eb82713e936be33597e1=DATA_CRYPTING_ON:fa69951bc733eb82713e936be33597e1=WABTECHS_CRYPTING_ON: e91497f38407364c8e86ade9098950d978814190&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3VIRAZA_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&WABTECHS_CRYPTING_ON_LAVINGOL&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&b557c222c8ddcdf87e033706aad08e4ef7cf90d3=course--cote-s2--<?= $row->id ?>"><i class="fas fa-grip-vertical text-blue"></i>Rattrapage</a>
                                                <a class="dropdown-item" href="?fa69951bc733eb82713e936be33597e1=DATA_CRYPTING_ON:fa69951bc733eb82713e936be33597e1=WABTECHS_CRYPTING_ON: e91497f38407364c8e86ade9098950d978814190&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3VIRAZA_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&WABTECHS_CRYPTING_ON_LAVINGOL&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&b557c222c8ddcdf87e033706aad08e4ef7cf90d3=course--recours-s2--<?= $row->id ?>"><i class="fas fa-grip-vertical text-blue"></i>Rattrapage (Recours)</a>
                                            <?php } else { ?>
                                                <!-- <a class="dropdown-item" href="?fa69951bc733eb82713e936be33597e1=DATA_CRYPTING_ON:fa69951bc733eb82713e936be33597e1=WABTECHS_CRYPTING_ON: e91497f38407364c8e86ade9098950d978814190&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3VIRAZA_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&WABTECHS_CRYPTING_ON_LAVINGOL&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&b557c222c8ddcdf87e033706aad08e4ef7cf90d3=course--cote-mem--<?= $row->id ?>"><i class="fas fa-grip-vertical text-blue"></i>Cotation</a> -->
                                                <a class="dropdown-item" href="?fa69951bc733eb82713e936be33597e1=DATA_CRYPTING_ON:fa69951bc733eb82713e936be33597e1=WABTECHS_CRYPTING_ON: e91497f38407364c8e86ade9098950d978814190&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3VIRAZA_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&WABTECHS_CRYPTING_ON_LAVINGOL&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&b557c222c8ddcdf87e033706aad08e4ef7cf90d3=course--cote-mem2--<?= $row->id ?>"><i class="fas fa-grip-vertical text-blue"></i>Rattrapage</a>
                                                <a class="dropdown-item" href="?fa69951bc733eb82713e936be33597e1=DATA_CRYPTING_ON:fa69951bc733eb82713e936be33597e1=WABTECHS_CRYPTING_ON: e91497f38407364c8e86ade9098950d978814190&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3VIRAZA_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&WABTECHS_CRYPTING_ON_LAVINGOL&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&b557c222c8ddcdf87e033706aad08e4ef7cf90d3=course--cote-mem3--<?= $row->id ?>"><i class="fas fa-grip-vertical text-blue"></i>Rattrapage (recours)</a>
                                            <?php } ?>
                                            <a class="dropdown-item" href="?fa69951bc733eb82713e936be33597e1=DATA_CRYPTING_ON:fa69951bc733eb82713e936be33597e1=WABTECHS_CRYPTING_ON: e91497f38407364c8e86ade9098950d978814190&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3VIRAZA_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&WABTECHS_CRYPTING_ON_LAVINGOL&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&b557c222c8ddcdf87e033706aad08e4ef7cf90d3=course--cotation--<?= $row->id ?>"><i class="fas fa-redo-alt text-orange-peel"></i>Explorer</a>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                    <?php } ?>
                </tbody>
            </table>
        </div>
    </div>
</div>
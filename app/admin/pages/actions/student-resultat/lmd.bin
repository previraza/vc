<?php
   $sems = [];
   $COURSES = $db_poo->query(
      "SELECT 
         courses.name AS ec_name, courses.credit AS ec_credit, courses.id, courses.part,
         ue.ue AS ue_credit, ue.code AS ue_code, ue.name AS ue_name,
         ROUND(CASE WHEN `cotes`.`RMC` != 0 THEN `cotes`.`RMC` ELSE ((`cotes`.`TP1`+`cotes`.`TP2`+`cotes`.`TP3`)/12+(`cotes`.`INT1`+`cotes`.`INT2`)/8+`cotes`.`EXAM`/2) END,2) AS cote_total, 
         CASE WHEN `cotes`.`RRC` != 0 THEN `cotes`.`RRC` ELSE `cotes`.`RATR` END AS `cote_ratr`,
         cotes.JURY AS cote_jury
      FROM $table.courses
         LEFT JOIN $table.ue
            ON ue.id = courses.ue
         LEFT JOIN $table.cotes
            ON (cotes.course = courses.id AND cotes.student = $std->id)
      WHERE 
         courses.class = $std->class  
         AND courses.active = 1 AND courses.delete = 0
      ORDER BY courses.part, courses.id
      "
   ) or die ('<h1>Une erreur SQL a ete detecte</h1><span>'.$db_poo->error.'</span>') ; while ($course = $COURSES->fetch_object()) {
      if(!isset($sems[$course->part]))$sems[$course->part]=['order'=>[],'ue'=>[], 'ec' => []];
      if(!isset($sems[$course->part]['ue'][$course->ue_code]))$sems[$course->part]['ue'][$course->ue_code]=[];
      if(!in_array($course->ue_code, $sems[$course->part]['order'])){
         $sems[$course->part]['order'][] = $course->ue_code;
      } $sems[$course->part]['ue'][$course->ue_code][] = $course;
   } $_SERVER['SCRIPT_URI'] = isset($_SERVER['SCRIPT_URI'])?$_SERVER['SCRIPT_URI']:'http://'.$_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];
?>
<!doctype html>
<html class="no-js" lang="zxx">
   <head>
      <meta charset="utf-8">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
      <link rel="icon" type="image/png" href="/public/assets/img/logo/logo-white.webp">
      <meta name="msapplication-TileColor" content="#ffffff">
      <meta name="msapplication-TileImage" content="/public/assets/img/logo/logo-white.webp">
      <meta name="theme-color" content="#ffffff">
      <link rel="preconnect" href="https://fonts.googleapis.com/">
      <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&amp;display=swap" rel="stylesheet">
      <link rel="stylesheet" href="../assets/css/app.min.css">
      <link rel="stylesheet" href="../assets/css/style.css">
      <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
      <style>
         td.update-case{
            -webkit-user-modify: read-write;
            background-color: #444;
            color:wheat;
         }.table-style8 th, .table-style8 td {
            padding: 4px;
            font-size: 10px;
            line-height: 1;
         }.del-on-print th {border-radius: 0 !important;}.del-on-print tbody th {padding-left: 10px !important;}.del-on-print td {text-align: center !important;}
      </style>
      <style type="text/css" media="print">
         #download_section > header > div.svg-shape1{
            top:-30px
         }
      </style>

      <title>RELEVÉ DE COTES <?=$table=='snem'?'NOTES PROVISOIRE':'COTES'?> - <?=$std->fullname?></title>
   </head>
   <body>
      <div class="invoice-container-wrap">
         <div class="invoice-container">
            <main>
               <div class="as-invoice invoice_style15">
                  <div class="download-inner" id="download_section">
                     <header class="as-header header-layout11 py-0 mb-5">
                        <div class="row align-items-center justify-content-between">
                           <div class="col-auto">
                              <div class="header-logo">
                                <a href="/">
                                   <div id="qrcode"></div>
                                    <img class='d-none' src="https://th.bing.com/th/id/OIP.n2saXL7xX6_GmI3hgYyl5gHaHa?w=174&h=180&c=7&r=0&o=5&pid=1.7" alt="Profil-ISTA-student" width="100px" height="100px">
                                </a>
                              </div>
                           </div>
                           <div class="col-auto">
                              <div class="div-content-left row">
                                 <div class="col-auto">
                                    <span class="text-uppercase">Institut Supérieur des Techniques Appliquées (I.S.T.A.)</span>
                                    <h4 class="text-uppercase text-end mb-0">Relevé de <?=$table=='snem'?'notes provisoire':'cotes'?></h4>
                                    <span>Année Académique 2021-2022</span>
                                 </div>
                                 <div class="col p-0">
                                    <a href="/" target="_blank" rel="noopener noreferrer">
                                       <img src="/public/assets/img/logo/logo-white.webp" alt="Profil-ISTA-student" width="100px" height="100px">
                                    </a>
                                 </div>
                              </div>
                           </div>
                        </div>
                        <div class="svg-shape1">
                           <svg width="800" height="164" viewBox="0 0 800 164" fill="none"
                              xmlns="http://www.w3.org/2000/svg">
                              <mask id="mask0_102_867" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0"
                                 y="0" width="800" height="164">
                                 <path
                                    d="M800 0H0V21H109.436C162.842 21 212.664 47.8721 242 92.5C271.336 137.128 321.158 164 374.564 164H800V0Z"
                                    fill="#010F1C" />
                              </mask>
                              <g mask="url(#mask0_102_867)">
                                 <rect x="-12" y="-233" width="821" height="548" fill="#F2F2F2" />
                                 <g style="mix-blend-mode:soft-light">
                                    <rect width="800" height="164" fill="#010F1C" />
                                 </g>
                              </g>
                           </svg>
                        </div>
                     </header>
                     <div class="row justify-content-between my-4">
                        <div class="col-6">
                           <div class="invoice-left row">
                              <span>
                                 <b>NOM COMPLET : </b>
                                 <span><?=$std->fullname?></span>
                              </span>
                              <span>
                                 <b>SECTION : </b>
                                 <span><?=$std->section?></span>
                              </span>
                           </div>
                        </div>
                        <div class="col-6">
                           <div class="invoice-left row">
                              <span>
                                 <b>NIVEAU : </b>
                                 <span><?=$std->level?></span>
                              </span>
                              <span>
                                 <b>OPTION : </b>
                                 <span><?=$std->option?> (<?=$std->class_name?>)</span>
                              </span>
                           </div>
                        </div>
                     </div>
                     <hr class="style1">
                     <div class='mine--table'>
                        <table class="table-style8">
                           <thead class=text-center>
                              <tr>
                                    <th rowspan=2>CODE UE</th>
                                    <th rowspan=2>(UE) UNITÉ D'ENSEIGNEMENT</th>
                                    <th>UE</th>
                                    <th rowspan=2>(EC) ÉLÉMENTS CONSTITUTIFS</th>
                                    <th colspan=2>EC</th>
                                    <th class=text-center rowspan=2>NOTE FINAL</th>
                              </tr>
                              <tr>
                                    <th>CRÉDIT</th>
                                    <th>CRÉDIT</th>
                                    <th>COTE</th>
                              </tr>
                           </thead>
                           <tbody>
                              <?php $all_res_mults = $final_res= $final_credit= $final_credit_valide=0; foreach ($sems as $part => $sem) {
                                 $sem_tr = ''; $sem['credit'] = $sem['credit_valide'] = $res_mults = 0;?>
                                 <tr>
                                    <th colspan=6 class="text-center text-uppercase"><?= $__part[$part]??'Undefined' ?> SEMESTRE</th>
                                    </tr>
                                    <?php foreach ($sem['order'] as $ue) {
                                    $ue_writed = false; 
                                    foreach ($sem['ue'][$ue] as $ec) {
                                       $cote_final = $ec->cote_ratr>$ec->cote_total?$ec->cote_ratr:$ec->cote_total;
                                       $res = (isset($ec->cote_jury)&&($ec->cote_jury>$cote_final||$ec->cote_jury>=10)?$ec->cote_jury:$cote_final);
                                       $final_res += $res*$ec->ec_credit;
                                       $sem['credit'] += $ec->ec_credit;
                                       $sem['credit_valide'] += $res>=10?$ec->ec_credit:0;
                                       $sem_tr.='<tr>';
                                       if(!$ue_writed){
                                          $sem_tr.= '<td rowspan='.count($sem['ue'][$ue]).'>'.$ec->ue_code.'</td>';
                                          $sem_tr.= '<td rowspan='.count($sem['ue'][$ue]).'>'.$ec->ue_name.'</td>';
                                          $sem_tr.= '<td class=text-center rowspan='.count($sem['ue'][$ue]).'>'.$ec->ue_credit.'</td>';
                                       }
                                       $sem_tr.= '<td>'.$ec->ec_name.'</td>';
                                       $sem_tr.= '<td class=text-center>'.$ec->ec_credit.'</td>';
                                       $sem_tr.= '<td class=text-center>'.($res!=0?$res:'-').'</td>';
                                       $sem_tr.= '<td class=text-center>'.($res_mult=$res*$ec->ec_credit).'</td>';
                                       $sem_tr.='</tr>';
                                       $ue_writed = true;$res_mults+=$res_mult;
                                    } 
                                    } ?>
                                    <?=$sem_tr?>
                                    <tr>
                                    <th colspan=2>CRÉDITS VALIDÉS</th>
                                    <th class=text-center><?=$sem['credit']?></th>
                                    <th></th>
                                    <th class=text-center colspan=2><?=$sem['credit_valide']?></th>
                                    <th class=text-center><?=$res_mults?></th>
                                    </tr>
                              <?php $final_credit+=$sem['credit']; $final_credit_valide+=$sem['credit_valide']; $all_res_mults += $res_mults; } ?>
                           </tbody>
                           <tfoot style="border-top: 3px solid;">
                              <tr>
                                    <th colspan=2>TOTAL CRÉDIT VALIDÉ</th>
                                    <th class=text-center><?=$final_credit?></th>
                                    <th></th>
                                    <th colspan=2 class=text-center colspan=2><?=$final_credit_valide?></th>
                                    <th rowspan=2 class=text-center><?=$final_res_=number_format($final_res/60,2)?></th>
                              </tr>
                              <tr>
                                    <th colspan=2>MOYENNE GENERALE ANNUELLE</th>
                                    <th class=text-center>20</th>
                                    <th></th>
                                    <th class=text-center colspan=2><?=number_format($all_res_mults,1)?> / 1200</th>
                              </tr>
                              <tr>
                                    <th colspan=4>GRADE CECT</th>
                                    <th colspan=3 class=text-center colspan=2><?= $mention = (($final_res_ >= 18) ? 'A' : (($final_res_ >= 16) ? 'B' : (($final_res_ >= 14) ? 'C' : (($final_res_ >= 12) ? 'D' : (($final_res_ >= 10) ? 'E' : (($final_res_ >= 8) ? 'F' : 'G'))))))?></th>
                              </tr>
                           </tfoot>
                        </table>
                        <p class="invoice-note mt-3">
                           <svg width="13" height="16" viewBox="0 0 13 16" fill="none"
                              xmlns="http://www.w3.org/2000/svg">
                              <path
                                    d="M3.22969 12.6H9.77031V11.4H3.22969V12.6ZM3.22969 9.2H9.77031V8H3.22969V9.2ZM1.21875 16C0.89375 16 0.609375 15.88 0.365625 15.64C0.121875 15.4 0 15.12 0 14.8V1.2C0 0.88 0.121875 0.6 0.365625 0.36C0.609375 0.12 0.89375 0 1.21875 0H8.55156L13 4.38V14.8C13 15.12 12.8781 15.4 12.6344 15.64C12.3906 15.88 12.1063 16 11.7812 16H1.21875ZM7.94219 4.92V1.2H1.21875V14.8H11.7812V4.92H7.94219ZM1.21875 1.2V4.92V1.2V14.8V1.2Z"
                                    fill="#1CB9C8" />
                           </svg>
                           <b>REMARQUE : </b> L'étudiant ayant validé moins de 45 crédits ou capitalisé une moyenne inférieure à 10, double de classe.
                        </p>
                        <p class="company-address style2"><b>ISTA</b><br>Kinshasa RDC</p>
                        <div class="body-shape1"></div>
                        <table class="invoice-table table-style8 del-on-print">
                           <thead>
                              <tr class=text-center>
                                    <th>Grade</th>
                                    <th>Note / 20 </th>
                                    <th>Status de l'etudiant ayant obtenue plus de 45 credit</th>
                              </tr>
                           </thead>
                           <tbody>
                              <tr>
                                    <td>G</td>
                                    <td> ≤ 7/20 </td>
                                    <th>Insatisfaisant</th>
                              </tr>
                              <tr>
                                    <td>F</td>
                                    <td> ≥ 8/20 </td>
                                    <th>Insuffisant</th>
                              </tr>
                              <tr>
                                    <td>E</td>
                                    <td> ≥ 10/20 </td>
                                    <th>Passable</th>
                              </tr>
                              <tr>
                                    <td>D</td>
                                    <td> ≥ 12/20 </td>
                                    <th>Assez Bien</th>
                              </tr>
                              <tr>
                                    <td>C</td>
                                    <td> ≥ 14/20 </td>
                                    <th>Bien</th>
                              </tr>
                              <tr>
                                    <td>B</td>
                                    <td> ≥ 16/20 </td>
                                    <th>Très Bien</th>
                              </tr>
                              <tr>
                                    <td>A</td>
                                    <td> ≥ 18/20 </td>
                                    <th>Excellent</th>
                              </tr>
                           </tbody>
                        </table>
                        <structure>
                           <!-- Primary Meta Tags -->
                           <meta name="keywords" content="institut, technique, application, université, kinshasa, industrie, informatique, aviation, mecanique, telecommunication, electronique, electricite, maintenance materiaux medicales, preparatoire, apprentissage, technologie, universtic">
                           <meta name="author" content="Mci Mangala">
                           <meta name="robots" content="INDEX,FOLLOW">
                           <meta name="title" content="RELEVÉ DE COTES <?=$table=='snem'?'NOTES PROVISOIRE':'COTES'?> - <?=$std->fullname?>">
                           <meta name="description" content="Relevé de note de l'étudiant Mangala ayant obtenu une note de <?=$final_res_?>/20 et capitalisé <?=$final_credit_valide?> crédit <?=$final_res_>=10&&$final_credit_valide>=45?'passe':'reprend'?> de classe avec <?=60-$final_credit_valide?> crédit de dettes.">

                           <!-- Open Graph / Facebook -->
                           <meta property="og:type" content="website">
                           <meta property="og:url" content="<?=$_SERVER['SCRIPT_URI']?>">
                           <meta property="og:title" content="RELEVÉ DE COTES <?=$table=='snem'?'NOTES PROVISOIRE':'COTES'?> - <?=$std->fullname?>">
                           <meta property="og:description" content="Relevé de note de l'étudiant Mangala ayant obtenu une note de <?=$final_res_?>/20 et capitalisé <?=$final_credit_valide?> crédit <?=$final_res_>=10&&$final_credit_valide>=45?'passe':'reprend'?> de classe avec <?=60-$final_credit_valide?> crédit de dettes.">
                           <meta property="og:image" content="<?=$_SERVER['SCRIPT_URI']?>releve.png">

                           <!-- Twitter -->
                           <meta property="twitter:card" content="summary_large_image">
                           <meta property="twitter:url" content="<?=$_SERVER['SCRIPT_URI']?>">
                           <meta property="twitter:title" content="RELEVÉ DE COTES <?=$table=='snem'?'NOTES PROVISOIRE':'COTES'?> - <?=$std->fullname?>">
                           <meta property="twitter:description" content="Relevé de note de l'étudiant Mangala ayant obtenu une note de <?=$final_res_?>/20 et capitalisé <?=$final_credit_valide?> crédit <?=$final_res_>=10&&$final_credit_valide>=45?'passe':'reprend'?> de classe avec <?=60-$final_credit_valide?> crédit de dettes.">
                           <meta property="twitter:image" content="<?=$_SERVER['SCRIPT_URI']?>releve.png">
                        </structure>
                     </div>
                  </div>
                  <div class="invoice-buttons">
                     <button class="print_btn">
                        <svg width="16" height="16"
                           viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                           <path
                              d="M11.9688 8.46875C12.1146 8.32292 12.2917 8.25 12.5 8.25C12.7083 8.25 12.8854 8.32292 13.0312 8.46875C13.1771 8.61458 13.25 8.79167 13.25 9C13.25 9.20833 13.1771 9.38542 13.0312 9.53125C12.8854 9.67708 12.7083 9.75 12.5 9.75C12.2917 9.75 12.1146 9.67708 11.9688 9.53125C11.8229 9.38542 11.75 9.20833 11.75 9C11.75 8.79167 11.8229 8.61458 11.9688 8.46875ZM13.5 5.5C14.1875 5.5 14.7708 5.75 15.25 6.25C15.75 6.72917 16 7.3125 16 8V12C16 12.1458 15.9479 12.2708 15.8438 12.375C15.7604 12.4583 15.6458 12.5 15.5 12.5H13.5V15.5C13.5 15.6458 13.4479 15.7604 13.3438 15.8438C13.2604 15.9479 13.1458 16 13 16H3C2.85417 16 2.72917 15.9479 2.625 15.8438C2.54167 15.7604 2.5 15.6458 2.5 15.5V12.5H0.5C0.354167 12.5 0.229167 12.4583 0.125 12.375C0.0416667 12.2708 0 12.1458 0 12V8C0 7.3125 0.239583 6.72917 0.71875 6.25C1.21875 5.75 1.8125 5.5 2.5 5.5V1C2.5 0.729167 2.59375 0.5 2.78125 0.3125C2.96875 0.104167 3.1875 0 3.4375 0H10.375C10.7917 0 11.1458 0.145833 11.4375 0.4375L13.0625 2.0625C13.3542 2.35417 13.5 2.70833 13.5 3.125V5.5ZM4 1.5V5.5H12V3.5H10.5C10.3542 3.5 10.2292 3.45833 10.125 3.375C10.0417 3.27083 10 3.14583 10 3V1.5H4ZM12 14.5V12.5H4V14.5H12ZM14.5 11V8C14.5 7.72917 14.3958 7.5 14.1875 7.3125C14 7.10417 13.7708 7 13.5 7H2.5C2.22917 7 1.98958 7.10417 1.78125 7.3125C1.59375 7.5 1.5 7.72917 1.5 8V11H14.5Z"
                              fill="white" />
                        </svg>
                        <span>Imprimer</span>
                     </button>
                     <button id="share_btn" class="download_btn">
                        <svg
                           width="18" height="16" viewBox="0 0 18 16" fill="none"
                           xmlns="http://www.w3.org/2000/svg">
                           <path
                              d="M16.5 9C16.9167 9 17.2708 9.14583 17.5625 9.4375C17.8542 9.72917 18 10.0833 18 10.5V14.5C18 14.9167 17.8542 15.2708 17.5625 15.5625C17.2708 15.8542 16.9167 16 16.5 16H1.5C1.08333 16 0.729167 15.8542 0.4375 15.5625C0.145833 15.2708 0 14.9167 0 14.5V10.5C0 10.0833 0.145833 9.72917 0.4375 9.4375C0.729167 9.14583 1.08333 9 1.5 9H4.375L2.9375 7.5625C2.47917 7.08333 2.375 6.54167 2.625 5.9375C2.875 5.3125 3.33333 5 4 5H6V1.5C6 1.08333 6.14583 0.729167 6.4375 0.4375C6.72917 0.145833 7.08333 0 7.5 0H10.5C10.9167 0 11.2708 0.145833 11.5625 0.4375C11.8542 0.729167 12 1.08333 12 1.5V5H14C14.6667 5 15.125 5.3125 15.375 5.9375C15.6458 6.54167 15.5417 7.08333 15.0625 7.5625L13.625 9H16.5ZM4 6.5L9 11.5L14 6.5H10.5V1.5H7.5V6.5H4ZM16.5 14.5V10.5H12.125L10.0625 12.5625C9.77083 12.8542 9.41667 13 9 13C8.58333 13 8.22917 12.8542 7.9375 12.5625L5.875 10.5H1.5V14.5H16.5ZM13.9688 13.0312C13.8229 12.8854 13.75 12.7083 13.75 12.5C13.75 12.2917 13.8229 12.1146 13.9688 11.9688C14.1146 11.8229 14.2917 11.75 14.5 11.75C14.7083 11.75 14.8854 11.8229 15.0312 11.9688C15.1771 12.1146 15.25 12.2917 15.25 12.5C15.25 12.7083 15.1771 12.8854 15.0312 13.0312C14.8854 13.1771 14.7083 13.25 14.5 13.25C14.2917 13.25 14.1146 13.1771 13.9688 13.0312Z"
                              fill="white" />
                        </svg>
                        <span>Partager</span>
                     </button>
                  </div>
               </div>
            </main>
         </div>
      </div>
      <script
         src="../assets/js/vendor/jquery-3.6.0.min.js"></script><script
         src="../assets/js/app.min.js"></script><script
         src="../assets/js/main.js"></script><script>
            const qrcode = new QRCode(document.getElementById('qrcode'), {
               text: location.href+'&anacad=2022',
               width: 125,
               height: 125,
               colorDark : '#000',
               colorLight : '#fff',
               correctLevel : QRCode.CorrectLevel.H
            });
      </script>
   </body>
</html>
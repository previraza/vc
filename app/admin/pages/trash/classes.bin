<?php viewOnlyBy('ADMIN'); $pageTitle = "Liste de Classes supprimer" ;
    $_SESSION['DATA_CACHE']['section_classe']=$_POST['section_classe'] = isset($_POST['section_classe']) ? $_POST['section_classe'] : (isset($_SESSION['DATA_CACHE']['section_classe']) ? $_SESSION['DATA_CACHE']['section_classe'] : $_SESSION['DATA_CACHE']['section_classe'] = NULL);
    $_SESSION['DATA_CACHE']['option_classe']=$_POST['option_classe'] = isset($_POST['option_classe']) ? $_POST['option_classe'] : (isset($_SESSION['DATA_CACHE']['option_classe']) ? $_SESSION['DATA_CACHE']['option_classe'] : $_SESSION['DATA_CACHE']['option_classe'] = NULL);
    if(isset($_POST['action'], $_POST['classe'])) mysqli_query($db, "UPDATE classes SET $_POST[action] = !$_POST[action] WHERE id = $_POST[classe]");
    if(isset($_POST['sendBy']) && $_POST['sendBy'] == 'adminer_norefer') die('success');
    if (isset($_POST['item_id']) && is_numeric($_POST['item_id'])){
        if ($db->query("UPDATE `classes` SET `delete` = 0 WHERE `classes`.`id` = $_POST[item_id]")){ ?>
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Close</span>
                </button>
                <strong>Succes : </strong>
                La classe selectionée a été restoré avec succès.
            </div>
        <?php }else{ ?>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Close</span>
                </button>
                <strong>Echec : </strong>
                La classe choisit est introuvable. 
            </div>
        <?php } 
    }
?>
<div class="card height-auto">
    <div class="card-body">
        <div class="heading-layout1">
            <div class="item-title">
                <h3>Liste de Classes</h3>
            </div>
            <div class="dropdown">
                <a class="dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-expanded="false">...</a>
                <div class="dropdown-menu dropdown-menu-right">
                    <a class="dropdown-item" href="?fa69951bc733eb82713e936be33597e1=DATA_CRYPTING_ON:fa69951bc733eb82713e936be33597e1=WABTECHS_CRYPTING_ON: e91497f38407364c8e86ade9098950d978814190&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3VIRAZA_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&WABTECHS_CRYPTING_ON_LAVINGOL&MCISME_LAVINGOL&b557c222c8ddcdf87e033706aad08e4ef7cf90d3&b557c222c8ddcdf87e033706aad08e4ef7cf90d3=class--add"><i class="fas fa-plus text-dark-pastel-green"></i>Add</a>
                    <div class="dropdown-item btn" onclick="submitAll('delib')"><i class="fas fa-directions text-orange-peel"></i>P. déliberation</div>
                    <div class="dropdown-item btn" onclick="submitAll('finished')"><i class="fas fa-allergies text-danger"></i>F. déliberation</div>
                    <a class="dropdown-item" href="#" data-action="print"><i class="fas fa-print"></i>print</a>
                    <a class="dropdown-item" href="#" data-action="reload"><i class="fas fa-redo-alt text-orange-peel"></i>Actualiser</a>
                </div>
            </div>
        </div>
        <form class="mg-b-20" method="POST" id="formSearchClassOfSection">
            <div class="row gutters-8">
                <div class="col-xl-3 col-lg-6 col-12 form-group"> <input type="hidden" name="CON_47" value="true">
                    <label><?=$mci?></label> <select class="select2" name="section_classe" id="s_sec">
                        <option value="*">Toutes les <?=$mci?>s</option>
                        <?php $rqt = mysqli_query($db, "SELECT id, name FROM sections WHERE active = 1") or die(debug(mysqli_error($db))); while ($ROW = mysqli_fetch_array($rqt)){ $row = (object) $ROW; $_fs = isset($_fs) ? $_fs : $row->id?>
                            <option value="<?= $row->id ?>"
                            <?php if(isset($_POST['section_classe']) && $row->id == $_POST['section_classe']) {echo 'selected'; $_fs = $row->id;} ?>>
                            <?= $row->name ?></option> <?php } ?>
                    </select> </div>
                    <div class="col-xl-3 col-lg-6 col-12 form-group"> <label>Option</label> <select class="select2"
                    name="option_classe" id="s_opt">
                    <option value="*">Toutes les options</option>
                    <?php $rqt = mysqli_query($db, "SELECT id, name FROM options WHERE active = 1 AND ".($_fs=='*'?'1':'section = '.$_fs)) or die(debug(mysqli_error($db))); while ($ROW = mysqli_fetch_array($rqt)){ $row = (object) $ROW; $_fo = isset($_fo) ? $_fo : $row->id?>
                        <option value="<?= $row->id ?>"
                        <?php if(isset($_POST['option_classe']) && $row->id == $_POST['option_classe']) {echo 'selected'; $_fo = $row->id;} ?>>
                        <?= $row->name ?></option> <?php } ?> 
                    </select> </div>
                <div class="col-xl-3 col-lg-6 col-12 form-group"> <label>Niveau</label> <select class="select2"
                        name="level_classe">
                        <option selected value="*">Tous les niveaux</option>
                        <?php $rqt = mysqli_query($db, "SELECT * FROM level WHERE active = 1") or die(debug(mysqli_error($db))); while ($ROW = mysqli_fetch_array($rqt)){ $row = (object) $ROW; ?>
                        <option value="<?= $row->id ?>"><?= $row->name ?></option> <?php } ?> <input type="hidden"
                            name="CON_47" value="true">
                    </select> </div>
                <div class="col-xl-3 col-lg-6 col-12 form-group"> <label>Promotion *</label> <select class="select2"
                        name="promotion_classe">
                        <option selected value="*">Année Académique </option>
                        <?php $year = 2023; while ($year > 2021){ ?> <option value="<?= --$year ?>">
                            <?= $year." - ".($year+1); ?></option> <?php } ?> <input type="hidden" name="CON_47"
                            value="true">
                    </select> </div>
                <div class="col-12 form-group"> <label></label> <button type="submit"
                        class="fw-btn-fill btn-gradient-yellow">RECHERCHE</button> </div>
            </div>
        </form>
        <div class="table-responsive">
            <table class="table display data-table text-nowrap">
                <thead>
                    <tr>
                        <th>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input checkAll" id="assosLabel">
                                <label for="assosLabel" class="form-check-label">Id</label>
                            </div>
                        </th>
                        <th>Designation</th>
                        <th><?=$mci?></th>
                        <th>Option</th>
                        <th>Niveau</th>
                        <th>Titulaire</th>
                        <th>M</th>
                        <th>D</th>
                        <th>F</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <?php $rqt = mysqli_query($db, 
                        "SELECT classes.*, CONCAT(teachers.firstname, ' ', teachers.lastname) AS titulary, sections.name AS section_name, options.name AS option_name, level.name AS level_name 
                            FROM classes 
                            LEFT JOIN teachers ON teachers.id = classes.titular 
                            LEFT JOIN sections ON sections.id = classes.section 
                            LEFT JOIN options  ON options.id  = classes.option 
                            LEFT JOIN level    ON level.id    = classes.level 
                            WHERE classes.active = 1 AND classes.delete = 1 AND  teachers.active = 1 AND teachers.delete = 0" 
                                .((isset($_POST['promotion_classe']) && $_POST['promotion_classe'] != "*") ? " AND classes.promotion = $_POST[promotion_classe]":'')
                                .((isset($_POST['section_classe']) && $_POST['section_classe'] != "*") ? " AND classes.section = $_POST[section_classe]":'')
                                .((isset($_POST['option_classe']) && $_POST['option_classe'] != "*") ? " AND classes.option = $_POST[option_classe]":'')
                                .((isset($_POST['level_classe']) && $_POST['level_classe'] != "*") ? " AND classes.level = $_POST[level_classe]":'')
                        );
                        while ($ROW = mysqli_fetch_array($rqt)){ $row = (object) $ROW; ?>
                            <tr id="Element-<?= $row->id ?>" class="<?=$row->finished?'bg-dark text-warning':null?> <?=$row->delib?'bg-warning':null?>" data-id='<?= $row->id ?>'>
                                <td>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input">
                                        <label class="form-check-label">#<?= $row->id ?></label>
                                    </div>
                                </td>
                                <td><?= $row->name ?></td>
                                <td><?= $row->section_name ?></td>
                                <td><?= $row->option_name ?></td>
                                <td><?= $row->level_name ?></td>
                                <td><?= $row->titulary ?></td>
                                <td><?= $row->modify ?></td>
                                <td><?= $row->delib ?></td>
                                <td><?= $row->finished ?></td>
                                <td>
                                    <div class="dropdown"> 
                                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-expanded="false"> <span class="flaticon-more-button-of-three-dots"></span> </a>
                                        <div class="dropdown-menu dropdown-menu-right">
                                            <form action="" method="post">
                                                <button class="dropdown-item" type=submit name=item_id value="<?= $row->id ?>"><i class="fas fa-times text-orange-red"></i>Restoré</button>
                                            </form>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                    <?php } ?>
                </tbody>
            </table>
        </div>
    </div>
</div>